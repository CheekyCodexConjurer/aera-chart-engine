name: Release Gate

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install
        run: npm ci
      - name: Typecheck
        run: npm run check
      - name: Contract tests
        run: npm run test:contracts
      - name: Compute pipeline tests
        run: npm run test:compute
      - name: Public API surface
        run: npm run test:public-api
      - name: Harness smoke
        run: npm run test:ui:smoke
      - name: Replay harness
        run: npm run test:replay
      - name: PineScript parity
        run: npm run test:pinescript:parity
      - name: Bench baseline
        run: npm run bench:baseline
      - name: Bench interaction
        run: npm run bench:interaction
      - name: Bench gate
        run: npm run bench:gate
      - name: Release checks
        run: npm run release:check
      - name: Package dry run
        run: npm pack --dry-run
